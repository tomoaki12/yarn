<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ§¶ YarnWorld â€” ä¸–ç•Œã®æ¯›ç³¸ã‚’æ¢ãã†</title>
  <link href="https://fonts.googleapis.com/css2?family=Boogaloo&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --pink:   #FF6B9D;
      --yellow: #FFD93D;
      --teal:   #06D6A0;
      --blue:   #4CC9F0;
      --purple: #9B5DE5;
      --orange: #FF9F1C;
      --bg:     #FFF9F0;
      --dark:   #2D2D2D;
      --card-r: 20px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Nunito', sans-serif;
      background: var(--bg);
      color: var(--dark);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* â”€â”€ HEADER â”€â”€ */
    header {
      background: linear-gradient(135deg, var(--pink) 0%, var(--purple) 50%, var(--blue) 100%);
      padding: 20px 24px 28px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    header::before {
      content: '';
      position: absolute;
      top: -40px; left: -40px;
      width: 200px; height: 200px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
    }
    header::after {
      content: '';
      position: absolute;
      bottom: -60px; right: -30px;
      width: 260px; height: 260px;
      background: rgba(255,255,255,0.08);
      border-radius: 50%;
    }
    .logo {
      font-family: 'Boogaloo', cursive;
      font-size: clamp(2.4rem, 6vw, 4rem);
      color: #fff;
      letter-spacing: 2px;
      text-shadow: 3px 3px 0 rgba(0,0,0,0.15);
      position: relative; z-index: 1;
    }
    .logo span { color: var(--yellow); }
    .tagline {
      color: rgba(255,255,255,0.9);
      font-size: 1rem;
      font-weight: 700;
      margin-top: 4px;
      position: relative; z-index: 1;
      letter-spacing: 1px;
    }

    /* floating yarn balls decoration */
    .yarn-deco {
      position: absolute; z-index: 0;
      font-size: 2rem;
      animation: float 4s ease-in-out infinite;
      pointer-events: none;
    }
    .yarn-deco:nth-child(2) { top: 10px; right: 60px; animation-delay: .5s; }
    .yarn-deco:nth-child(3) { bottom: 8px; left: 40px; animation-delay: 1.2s; }
    .yarn-deco:nth-child(4) { top: 14px; left: 120px; animation-delay: 2s; font-size: 1.4rem; }
    @keyframes float {
      0%,100% { transform: translateY(0) rotate(-5deg); }
      50%      { transform: translateY(-10px) rotate(5deg); }
    }

    /* â”€â”€ SEARCH BAR â”€â”€ */
    .search-wrap {
      background: #fff;
      margin: 0 auto;
      max-width: 680px;
      padding: 20px 20px 0;
    }
    .search-row {
      display: flex;
      gap: 10px;
      background: #fff;
      border: 3px solid var(--purple);
      border-radius: 50px;
      padding: 6px 8px 6px 20px;
      box-shadow: 4px 4px 0 var(--purple);
    }
    #searchInput {
      flex: 1;
      border: none;
      outline: none;
      font-family: 'Nunito', sans-serif;
      font-size: 1rem;
      font-weight: 700;
      color: var(--dark);
      background: transparent;
    }
    #searchInput::placeholder { color: #aaa; font-weight: 600; }
    #searchBtn {
      background: var(--purple);
      color: #fff;
      border: none;
      border-radius: 40px;
      padding: 8px 22px;
      font-family: 'Boogaloo', cursive;
      font-size: 1.05rem;
      cursor: pointer;
      transition: background .2s, transform .1s;
    }
    #searchBtn:hover { background: var(--pink); transform: scale(1.04); }

    /* quick filter chips */
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 14px 20px;
      max-width: 680px;
      margin: 0 auto;
      background: #fff;
    }
    .chip {
      border: 2px solid currentColor;
      border-radius: 20px;
      padding: 4px 14px;
      font-size: .82rem;
      font-weight: 800;
      cursor: pointer;
      transition: all .15s;
      background: #fff;
    }
    .chip:hover, .chip.active { color: #fff; }
    .chip[data-q="wool"]    { color: var(--pink);   } .chip[data-q="wool"].active    { background: var(--pink); }
    .chip[data-q="merino"]  { color: var(--purple); } .chip[data-q="merino"].active  { background: var(--purple); }
    .chip[data-q="cotton"]  { color: var(--teal);   } .chip[data-q="cotton"].active  { background: var(--teal); }
    .chip[data-q="alpaca"]  { color: var(--orange); } .chip[data-q="alpaca"].active  { background: var(--orange); }
    .chip[data-q="silk"]    { color: var(--blue);   } .chip[data-q="silk"].active    { background: var(--blue); }
    .chip[data-q="linen"]   { color: var(--yellow); border-color: #e5b800; } .chip[data-q="linen"].active { background: var(--yellow); color: #333; }
    .chip[data-q="cashmere"]{ color: var(--pink); } .chip[data-q="cashmere"].active { background: var(--pink); }

    /* â”€â”€ MAIN CONTENT â”€â”€ */
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 16px 60px;
    }

    /* status bar */
    #statusBar {
      text-align: center;
      font-weight: 700;
      color: var(--purple);
      font-size: .95rem;
      min-height: 28px;
      margin-bottom: 12px;
    }

    /* API key notice */
    #apiKeyBox {
      background: #fff;
      border: 3px solid var(--yellow);
      border-radius: var(--card-r);
      padding: 20px 24px;
      margin: 16px 0 24px;
      box-shadow: 4px 4px 0 var(--yellow);
    }
    #apiKeyBox h3 {
      font-family: 'Boogaloo', cursive;
      font-size: 1.3rem;
      color: var(--orange);
      margin-bottom: 8px;
    }
    #apiKeyBox p { font-size: .9rem; line-height: 1.6; color: #555; margin-bottom: 12px; }
    #apiKeyBox a { color: var(--purple); font-weight: 700; }
    .key-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    #apiUser, #apiPass {
      flex: 1;
      min-width: 140px;
      padding: 8px 14px;
      border: 2px solid var(--purple);
      border-radius: 10px;
      font-family: 'Nunito', sans-serif;
      font-size: .9rem;
      font-weight: 700;
      outline: none;
    }
    #saveKeyBtn {
      background: var(--teal);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 9px 20px;
      font-family: 'Boogaloo', cursive;
      font-size: 1rem;
      cursor: pointer;
      transition: background .2s;
      white-space: nowrap;
    }
    #saveKeyBtn:hover { background: var(--purple); }
    #keyStatus { font-size: .85rem; font-weight: 700; color: var(--teal); margin-top: 6px; }

    /* â”€â”€ CARD GRID â”€â”€ */
    #grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 20px;
    }

    .yarn-card {
      background: #fff;
      border-radius: var(--card-r);
      overflow: hidden;
      border: 3px solid transparent;
      box-shadow: 4px 4px 0 rgba(0,0,0,0.08);
      transition: transform .2s, box-shadow .2s;
      animation: popIn .35s cubic-bezier(.34,1.56,.64,1) both;
      cursor: pointer;
    }
    .yarn-card:hover {
      transform: translateY(-5px) rotate(-0.5deg);
      box-shadow: 8px 8px 0 rgba(0,0,0,0.12);
    }
    .yarn-card:nth-child(6n+1) { border-color: var(--pink);   }
    .yarn-card:nth-child(6n+2) { border-color: var(--teal);   }
    .yarn-card:nth-child(6n+3) { border-color: var(--yellow); }
    .yarn-card:nth-child(6n+4) { border-color: var(--blue);   }
    .yarn-card:nth-child(6n+5) { border-color: var(--purple); }
    .yarn-card:nth-child(6n+6) { border-color: var(--orange); }

    @keyframes popIn {
      0%   { opacity: 0; transform: scale(.8) translateY(10px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }

    .card-img {
      width: 100%;
      aspect-ratio: 4/3;
      object-fit: cover;
      background: #f0f0f0;
      display: block;
    }
    .card-img-placeholder {
      width: 100%;
      aspect-ratio: 4/3;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3.5rem;
      background: linear-gradient(135deg, #f8f0ff, #fff0f8);
    }

    .card-body { padding: 14px 16px 16px; }
    .card-brand {
      font-size: .72rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--purple);
      margin-bottom: 2px;
    }
    .card-name {
      font-family: 'Boogaloo', cursive;
      font-size: 1.1rem;
      line-height: 1.3;
      margin-bottom: 8px;
      color: var(--dark);
    }
    .card-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
    .tag {
      font-size: .7rem;
      font-weight: 800;
      padding: 2px 9px;
      border-radius: 20px;
      color: #fff;
    }
    .tag-weight   { background: var(--blue);   }
    .tag-fiber    { background: var(--teal);   }
    .tag-washable { background: var(--pink);   }
    .tag-rating   { background: var(--orange); }

    .card-detail {
      font-size: .82rem;
      color: #666;
      line-height: 1.6;
    }
    .card-detail span { color: var(--dark); font-weight: 700; }

    .card-footer {
      border-top: 2px dashed #f0e0f0;
      padding: 10px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .stars { color: var(--yellow); font-size: .9rem; }
    .ravelry-link {
      font-size: .75rem;
      font-weight: 800;
      color: var(--purple);
      text-decoration: none;
      padding: 3px 10px;
      border: 2px solid var(--purple);
      border-radius: 20px;
      transition: all .15s;
    }
    .ravelry-link:hover { background: var(--purple); color: #fff; }

    /* â”€â”€ SKELETON â”€â”€ */
    .skeleton-card {
      background: #fff;
      border-radius: var(--card-r);
      border: 3px solid #eee;
      overflow: hidden;
      animation: pulse 1.4s ease-in-out infinite;
    }
    .skel-img  { width: 100%; aspect-ratio: 4/3; background: #f0f0f0; }
    .skel-body { padding: 14px 16px; }
    .skel-line { height: 12px; background: #f0f0f0; border-radius: 6px; margin-bottom: 10px; }
    .skel-line.w70 { width: 70%; }
    .skel-line.w50 { width: 50%; }
    @keyframes pulse {
      0%,100% { opacity: 1; } 50% { opacity: .5; }
    }

    /* â”€â”€ MODAL â”€â”€ */
    #modal {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    #modal.open { display: flex; }
    .modal-box {
      background: #fff;
      border-radius: 24px;
      max-width: 520px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 4px solid var(--purple);
      box-shadow: 8px 8px 0 var(--purple);
      animation: popIn .3s ease both;
    }
    .modal-img {
      width: 100%;
      aspect-ratio: 16/9;
      object-fit: cover;
      border-radius: 18px 18px 0 0;
    }
    .modal-img-placeholder {
      width: 100%; aspect-ratio: 16/9;
      display: flex; align-items: center; justify-content: center;
      font-size: 6rem;
      background: linear-gradient(135deg, #f8f0ff, #ffe8f8);
      border-radius: 18px 18px 0 0;
    }
    .modal-content { padding: 20px 24px 24px; }
    .modal-brand { color: var(--purple); font-weight: 800; font-size: .8rem; text-transform: uppercase; letter-spacing: 1.5px; }
    .modal-title { font-family: 'Boogaloo', cursive; font-size: 1.8rem; margin: 4px 0 12px; }
    .modal-tags  { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 14px; }
    .modal-grid  { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
    .modal-item  {
      background: #faf5ff;
      border-radius: 12px;
      padding: 10px 14px;
    }
    .modal-item label { font-size: .7rem; font-weight: 800; text-transform: uppercase; color: var(--purple); display: block; margin-bottom: 2px; }
    .modal-item value { font-size: .95rem; font-weight: 700; color: var(--dark); }
    .modal-notes { font-size: .88rem; color: #555; line-height: 1.7; margin-bottom: 16px; background: #fff9e6; border-radius: 12px; padding: 12px 16px; border-left: 4px solid var(--yellow); }
    .modal-actions { display: flex; gap: 10px; }
    .btn-ravelry {
      flex: 1;
      background: var(--purple);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 11px;
      font-family: 'Boogaloo', cursive;
      font-size: 1.05rem;
      cursor: pointer;
      text-align: center;
      text-decoration: none;
      transition: background .2s;
    }
    .btn-ravelry:hover { background: var(--pink); }
    .btn-close {
      background: #f0f0f0;
      color: var(--dark);
      border: none;
      border-radius: 12px;
      padding: 11px 16px;
      font-family: 'Boogaloo', cursive;
      font-size: 1.05rem;
      cursor: pointer;
      transition: background .2s;
    }
    .btn-close:hover { background: #ddd; }

    /* load more */
    #loadMore {
      display: block;
      margin: 32px auto 0;
      background: linear-gradient(135deg, var(--pink), var(--purple));
      color: #fff;
      border: none;
      border-radius: 50px;
      padding: 14px 40px;
      font-family: 'Boogaloo', cursive;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 4px 4px 0 rgba(0,0,0,0.15);
      transition: transform .15s, box-shadow .15s;
    }
    #loadMore:hover { transform: scale(1.05); box-shadow: 6px 6px 0 rgba(0,0,0,0.2); }
    #loadMore:disabled { opacity: .5; cursor: default; transform: none; }

    /* empty state */
    #emptyState {
      display: none;
      text-align: center;
      padding: 60px 20px;
      color: #aaa;
    }
    #emptyState .icon { font-size: 4rem; display: block; margin-bottom: 12px; }
    #emptyState p { font-weight: 700; font-size: 1.1rem; }

    /* â”€â”€ DEMO notice â”€â”€ */
    #demoNotice {
      background: linear-gradient(135deg, #fff0f8, #f0f0ff);
      border: 2px dashed var(--pink);
      border-radius: 16px;
      padding: 14px 18px;
      font-size: .85rem;
      color: #666;
      margin: 0 0 20px;
      line-height: 1.6;
      display: none;
    }
    #demoNotice strong { color: var(--purple); }

    /* responsive */
    @media (max-width: 500px) {
      #grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
      .modal-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="yarn-deco">ğŸ§¶</div>
  <div class="yarn-deco">ğŸ€</div>
  <div class="yarn-deco">âœ¨</div>
  <h1 class="logo">ğŸ§¶ Yarn<span>World</span></h1>
  <p class="tagline">ä¸–ç•Œä¸­ã®æ¯›ç³¸ã‚’ã²ã¨ã¤ã®å ´æ‰€ã§æ¢ãã†ï¼</p>
</header>

<!-- SEARCH -->
<div class="search-wrap">
  <div class="search-row">
    <input id="searchInput" type="text" placeholder="æ¯›ç³¸åãƒ»ç´ æãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰ã‚’æ¤œç´¢â€¦" />
    <button id="searchBtn">æ¤œç´¢ ğŸ”</button>
  </div>
</div>
<div class="chips">
  <span class="chip" data-q="wool">ğŸ‘ ã‚¦ãƒ¼ãƒ«</span>
  <span class="chip" data-q="merino">âœ¨ ãƒ¡ãƒªãƒ</span>
  <span class="chip" data-q="cotton">ğŸŒ¿ ã‚³ãƒƒãƒˆãƒ³</span>
  <span class="chip" data-q="alpaca">ğŸ¦™ ã‚¢ãƒ«ãƒ‘ã‚«</span>
  <span class="chip" data-q="silk">ğŸ•Šï¸ ã‚·ãƒ«ã‚¯</span>
  <span class="chip" data-q="linen">ğŸŒ¾ ãƒªãƒãƒ³</span>
  <span class="chip" data-q="cashmere">ğŸ‘‘ ã‚«ã‚·ãƒŸã‚¢</span>
</div>

<!-- MAIN -->
<main>

  <!-- API Key Box -->
  <div id="apiKeyBox">
    <h3>ğŸ”‘ Ravelry APIã‚­ãƒ¼ã‚’è¨­å®šã—ã‚ˆã†</h3>
    <p>
      <strong>Ravelry</strong>ï¼ˆä¸–ç•Œæœ€å¤§ã®æ¯›ç³¸ãƒ»ç·¨ã¿ç‰©ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼‰ã®APIã‚’ä½¿ã„ã¾ã™ã€‚<br>
      ç„¡æ–™ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ã€APIã‚­ãƒ¼ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚<br>
      ğŸ‘‰ <a href="https://www.ravelry.com/pro/developer" target="_blank">https://www.ravelry.com/pro/developer</a>
      ã§ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã€<em>Basic Authï¼ˆread-onlyï¼‰</em>ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
    </p>
    <div class="key-row">
      <input id="apiUser" type="text"     placeholder="APIãƒ¦ãƒ¼ã‚¶ãƒ¼å" />
      <input id="apiPass" type="password" placeholder="APIãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" />
      <button id="saveKeyBtn">ä¿å­˜ã—ã¦æ¤œç´¢ âœ“</button>
    </div>
    <p id="keyStatus"></p>
    <p style="font-size:.8rem; color:#aaa; margin-top:6px;">
      â€» ã‚­ãƒ¼ã¯ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚
    </p>
  </div>

  <div id="demoNotice">
    <strong>ğŸ¨ ãƒ‡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§è¡¨ç¤ºä¸­</strong> â€” Ravelry APIã‚­ãƒ¼ãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
    ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã§APIã‚­ãƒ¼ã‚’è¨­å®šã™ã‚‹ã¨ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ä¸–ç•Œä¸­ã®æ¯›ç³¸ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã™ï¼
  </div>

  <div id="statusBar"></div>
  <div id="grid"></div>
  <div id="emptyState">
    <span class="icon">ğŸ”</span>
    <p>æ¯›ç³¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è©¦ã—ã¦ã¿ã¦ï¼</p>
  </div>
  <button id="loadMore" style="display:none">ã‚‚ã£ã¨è¦‹ã‚‹ ğŸ§¶</button>
</main>

<!-- MODAL -->
<div id="modal">
  <div class="modal-box" id="modalBox"></div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let apiUser = localStorage.getItem('rv_user') || '';
let apiPass = localStorage.getItem('rv_pass') || '';
let currentQuery = 'wool';
let currentPage  = 1;
let totalPages   = 1;
let isLoading    = false;

const COLORS = [
  'var(--pink)','var(--teal)','var(--yellow)',
  'var(--blue)','var(--purple)','var(--orange)'
];
const EMOJIS = ['ğŸ§¶','ğŸ€','âœ¨','ğŸª¡','ğŸ’«','ğŸŒˆ','ğŸ¨','ğŸŒ¸'];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('apiUser').value = apiUser;
document.getElementById('apiPass').value = apiPass;

document.getElementById('saveKeyBtn').onclick = () => {
  apiUser = document.getElementById('apiUser').value.trim();
  apiPass = document.getElementById('apiPass').value.trim();
  if (!apiUser || !apiPass) {
    document.getElementById('keyStatus').textContent = 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
    document.getElementById('keyStatus').style.color = 'var(--pink)';
    return;
  }
  localStorage.setItem('rv_user', apiUser);
  localStorage.setItem('rv_pass', apiPass);
  document.getElementById('keyStatus').textContent = 'âœ… ä¿å­˜ã—ã¾ã—ãŸï¼';
  document.getElementById('keyStatus').style.color = 'var(--teal)';
  loadYarns(currentQuery, 1);
};

document.getElementById('searchBtn').onclick = () => {
  const q = document.getElementById('searchInput').value.trim();
  if (q) { clearChips(); search(q); }
};
document.getElementById('searchInput').onkeydown = e => {
  if (e.key === 'Enter') document.getElementById('searchBtn').click();
};

document.querySelectorAll('.chip').forEach(c => {
  c.onclick = () => {
    clearChips();
    c.classList.add('active');
    document.getElementById('searchInput').value = '';
    search(c.dataset.q);
  };
});

document.getElementById('loadMore').onclick = () => {
  loadYarns(currentQuery, currentPage + 1, true);
};

document.getElementById('modal').onclick = e => {
  if (e.target === document.getElementById('modal')) closeModal();
};

function clearChips() {
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
}
function search(q) {
  currentQuery = q;
  loadYarns(q, 1);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  API CALL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadYarns(query, page = 1, append = false) {
  if (isLoading) return;
  isLoading = true;

  const grid = document.getElementById('grid');
  const status = document.getElementById('statusBar');
  const loadMoreBtn = document.getElementById('loadMore');
  const emptyState = document.getElementById('emptyState');

  if (!append) {
    grid.innerHTML = '';
    emptyState.style.display = 'none';
  }

  // skeleton
  const skels = 8;
  const skelFrag = document.createDocumentFragment();
  if (!append) {
    for (let i = 0; i < skels; i++) {
      const s = document.createElement('div');
      s.className = 'skeleton-card';
      s.innerHTML = `<div class="skel-img"></div><div class="skel-body">
        <div class="skel-line w70"></div><div class="skel-line w50"></div></div>`;
      skelFrag.appendChild(s);
    }
    grid.appendChild(skelFrag);
  }
  status.textContent = 'èª­ã¿è¾¼ã¿ä¸­â€¦ ğŸ§¶';
  loadMoreBtn.style.display = 'none';

  if (!apiUser || !apiPass) {
    // DEMO mode
    if (!append) grid.innerHTML = '';
    document.getElementById('demoNotice').style.display = 'block';
    await sleep(400);
    const demos = getDemoData(query, page);
    renderCards(demos.yarns, append);
    currentPage = page;
    totalPages  = demos.pages;
    status.textContent = `ğŸ¨ ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­ï¼ˆ${demos.yarns.length}ä»¶ï¼‰`;
    loadMoreBtn.style.display = currentPage < totalPages ? 'block' : 'none';
    isLoading = false;
    return;
  }

  document.getElementById('demoNotice').style.display = 'none';

  try {
    const headers = {
      'Authorization': 'Basic ' + btoa(apiUser + ':' + apiPass)
    };
    const url = `https://api.ravelry.com/yarns/search.json?query=${encodeURIComponent(query)}&page=${page}&page_size=20&sort=best`;
    const res = await fetch(url, { headers });

    if (!append) grid.innerHTML = '';

    if (res.status === 401) {
      status.textContent = 'âŒ APIã‚­ãƒ¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      isLoading = false;
      return;
    }
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const data = await res.json();
    const yarns = data.yarns || [];
    const pag   = data.paginator || {};
    currentPage = page;
    totalPages  = Math.ceil((pag.results || yarns.length) / 20);

    if (yarns.length === 0 && !append) {
      emptyState.style.display = 'block';
      status.textContent = '';
    } else {
      renderCards(yarns, append);
      status.textContent = `${pag.results || yarns.length}ä»¶ã®æ¯›ç³¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ âœ¨`;
      loadMoreBtn.style.display = currentPage < totalPages ? 'block' : 'none';
    }
  } catch (err) {
    if (!append) grid.innerHTML = '';
    // fallback to demo
    document.getElementById('demoNotice').style.display = 'block';
    const demos = getDemoData(query, page);
    renderCards(demos.yarns, append);
    status.textContent = `âš ï¸ APIæ¥ç¶šã‚¨ãƒ©ãƒ¼ã€‚ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚`;
    currentPage = page;
    totalPages  = demos.pages;
    loadMoreBtn.style.display = currentPage < totalPages ? 'block' : 'none';
  }
  isLoading = false;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  RENDER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCards(yarns, append) {
  const grid = document.getElementById('grid');
  yarns.forEach((y, i) => {
    const card = buildCard(y, append ? grid.children.length + i : i);
    grid.appendChild(card);
  });
}

function buildCard(y, idx) {
  const card = document.createElement('div');
  card.className = 'yarn-card';
  card.style.animationDelay = `${(idx % 8) * 0.05}s`;

  const photo  = y.first_photo;
  const imgUrl = photo ? (photo.medium_url || photo.square_url || '') : '';
  const brand  = (y.yarn_company_name || y.brand || '');
  const name   = y.name || 'Unknown Yarn';
  const weight = y.yarn_weight?.name || '';
  const rating = y.rating_average ? (+y.rating_average).toFixed(1) : null;
  const stars  = ratingStars(rating);
  const fibers = getFibers(y);
  const grams  = y.grams ? `${y.grams}g` : '';
  const yardage= y.yardage ? `${y.yardage}m` : '';
  const permalink = y.permalink || '';

  const imgHtml = imgUrl
    ? `<img class="card-img" src="${imgUrl}" alt="${name}" loading="lazy" onerror="this.parentNode.innerHTML='<div class=card-img-placeholder>${randEmoji(idx)}</div>'">`
    : `<div class="card-img-placeholder">${randEmoji(idx)}</div>`;

  card.innerHTML = `
    ${imgHtml}
    <div class="card-body">
      ${brand ? `<div class="card-brand">${escHtml(brand)}</div>` : ''}
      <div class="card-name">${escHtml(name)}</div>
      <div class="card-tags">
        ${weight  ? `<span class="tag tag-weight">${escHtml(weight)}</span>` : ''}
        ${fibers.slice(0,2).map(f => `<span class="tag tag-fiber">${escHtml(f)}</span>`).join('')}
        ${y.machine_washable === 'yes' ? `<span class="tag tag-washable">æ´—æ¿¯æ©ŸOK</span>` : ''}
      </div>
      <div class="card-detail">
        ${grams   ? `é‡ã•: <span>${grams}</span>ã€€` : ''}
        ${yardage ? `é•·ã•: <span>${yardage}</span>` : ''}
      </div>
    </div>
    <div class="card-footer">
      <span class="stars">${stars}</span>
      ${permalink ? `<a class="ravelry-link" href="https://www.ravelry.com/yarns/library/${permalink}" target="_blank" rel="noopener">Ravelry â†—</a>` : ''}
    </div>`;

  card.onclick = () => openModal(y);
  return card;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MODAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(y) {
  const box = document.getElementById('modalBox');
  const photo  = y.first_photo;
  const imgUrl = photo ? (photo.medium_url || photo.square_url || '') : '';
  const brand  = y.yarn_company_name || y.brand || '';
  const name   = y.name || 'Unknown Yarn';
  const weight = y.yarn_weight?.name || 'â€”';
  const fibers = getFibers(y);
  const rating = y.rating_average ? (+y.rating_average).toFixed(1) : 'â€”';
  const grams  = y.grams   ? `${y.grams}g`   : 'â€”';
  const yardage= y.yardage ? `${y.yardage}m` : 'â€”';
  const permalink = y.permalink || '';
  const notes  = y.notes_html || '';

  const imgHtml = imgUrl
    ? `<img class="modal-img" src="${imgUrl}" alt="${name}" onerror="this.outerHTML='<div class=modal-img-placeholder>ğŸ§¶</div>'">`
    : `<div class="modal-img-placeholder">ğŸ§¶</div>`;

  box.innerHTML = `
    ${imgHtml}
    <div class="modal-content">
      ${brand ? `<div class="modal-brand">${escHtml(brand)}</div>` : ''}
      <div class="modal-title">${escHtml(name)}</div>
      <div class="modal-tags">
        ${weight !== 'â€”' ? `<span class="tag tag-weight">${escHtml(weight)}</span>` : ''}
        ${fibers.map(f => `<span class="tag tag-fiber">${escHtml(f)}</span>`).join('')}
        ${y.machine_washable === 'yes' ? `<span class="tag tag-washable">æ´—æ¿¯æ©ŸOK</span>` : ''}
      </div>
      <div class="modal-grid">
        <div class="modal-item"><label>é‡ã•</label><value>${grams}</value></div>
        <div class="modal-item"><label>é•·ã•</label><value>${yardage}</value></div>
        <div class="modal-item"><label>ç³¸ã®å¤ªã•</label><value>${escHtml(weight)}</value></div>
        <div class="modal-item"><label>è©•ä¾¡</label><value>${rating !== 'â€”' ? ratingStars(rating) + ' ' + rating : 'â€”'}</value></div>
        ${y.min_gauge ? `<div class="modal-item"><label>ã‚²ãƒ¼ã‚¸</label><value>${y.min_gauge}ã€œ${y.max_gauge || y.min_gauge}</value></div>` : ''}
        ${y.min_needle_size?.[0]?.us ? `<div class="modal-item"><label>é‡ã®ã‚µã‚¤ã‚º</label><value>US ${y.min_needle_size[0].us}</value></div>` : ''}
      </div>
      ${notes ? `<div class="modal-notes">${notes}</div>` : ''}
      <div class="modal-actions">
        ${permalink
          ? `<a class="btn-ravelry" href="https://www.ravelry.com/yarns/library/${permalink}" target="_blank" rel="noopener">Ravelryã§è¦‹ã‚‹ â†—</a>`
          : ''}
        <button class="btn-close" onclick="closeModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>`;

  document.getElementById('modal').classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeModal() {
  document.getElementById('modal').classList.remove('open');
  document.body.style.overflow = '';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DEMO DATA (when no API key)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getDemoData(query, page) {
  const base = [
    { id:1, name:'Cascade 220', yarn_company_name:'Cascade Yarns', permalink:'cascade-yarns-cascade-220',
      yarn_weight:{name:'Worsted'}, grams:100, yardage:200, rating_average:'4.8', machine_washable:'no',
      yarn_fibers:[{fiber:{name:'Wool'},percentage:100}],
      first_photo:{medium_url:'https://images.ravelrycache.com/uploads/Cascade/29784/CY_220.jpg'} },
    { id:2, name:'Malabrigo Rios', yarn_company_name:'Malabrigo', permalink:'malabrigo-rios',
      yarn_weight:{name:'Worsted'}, grams:100, yardage:192, rating_average:'4.9', machine_washable:'yes',
      yarn_fibers:[{fiber:{name:'Merino Wool'},percentage:100}] },
    { id:3, name:'Drops Alpaca', yarn_company_name:'Garnstudio Drops', permalink:'drops-alpaca',
      yarn_weight:{name:'Sport'}, grams:50, yardage:167, rating_average:'4.7',
      yarn_fibers:[{fiber:{name:'Alpaca'},percentage:65},{fiber:{name:'Wool'},percentage:35}] },
    { id:4, name:'Rowan Kidsilk Haze', yarn_company_name:'Rowan', permalink:'rowan-kidsilk-haze',
      yarn_weight:{name:'Lace'}, grams:25, yardage:210, rating_average:'4.5',
      yarn_fibers:[{fiber:{name:'Mohair'},percentage:70},{fiber:{name:'Silk'},percentage:30}] },
    { id:5, name:'Lion Brand Yarn 24/7 Cotton', yarn_company_name:'Lion Brand', permalink:'lion-brand-24-7-cotton',
      yarn_weight:{name:'Worsted'}, grams:100, yardage:186, rating_average:'4.3', machine_washable:'yes',
      yarn_fibers:[{fiber:{name:'Cotton'},percentage:100}] },
    { id:6, name:'Debbie Bliss Cashmerino Aran', yarn_company_name:'Debbie Bliss', permalink:'debbie-bliss-cashmerino-aran',
      yarn_weight:{name:'Aran'}, grams:50, yardage:90, rating_average:'4.6',
      yarn_fibers:[{fiber:{name:'Merino'},percentage:55},{fiber:{name:'Microfibre'},percentage:33},{fiber:{name:'Cashmere'},percentage:12}] },
    { id:7, name:'Noro Silk Garden', yarn_company_name:'Noro', permalink:'noro-silk-garden',
      yarn_weight:{name:'Aran'}, grams:50, yardage:100, rating_average:'4.4',
      yarn_fibers:[{fiber:{name:'Silk'},percentage:45},{fiber:{name:'Kid Mohair'},percentage:45},{fiber:{name:'Lambswool'},percentage:10}] },
    { id:8, name:'Berroco Ultra Wool', yarn_company_name:'Berroco', permalink:'berroco-ultra-wool',
      yarn_weight:{name:'Worsted'}, grams:100, yardage:219, rating_average:'4.7', machine_washable:'yes',
      yarn_fibers:[{fiber:{name:'Wool'},percentage:100}] },
    { id:9, name:'Blue Sky Fibers Woolstok', yarn_company_name:'Blue Sky Fibers', permalink:'blue-sky-fibers-woolstok',
      yarn_weight:{name:'Worsted'}, grams:50, yardage:123, rating_average:'4.5',
      yarn_fibers:[{fiber:{name:'Wool'},percentage:100}] },
    { id:10, name:'Paintbox Yarns Simply DK', yarn_company_name:'Paintbox Yarns', permalink:'paintbox-yarns-simply-dk',
      yarn_weight:{name:'DK'}, grams:100, yardage:276, rating_average:'4.2', machine_washable:'yes',
      yarn_fibers:[{fiber:{name:'Acrylic'},percentage:100}] },
    { id:11, name:'Opal Uni 4-ply', yarn_company_name:'Opal', permalink:'opal-uni-4-fach',
      yarn_weight:{name:'Fingering'}, grams:100, yardage:425, rating_average:'4.6', machine_washable:'yes',
      yarn_fibers:[{fiber:{name:'Wool'},percentage:75},{fiber:{name:'Polyamide'},percentage:25}] },
    { id:12, name:'Lana Grossa Cool Wool 2000', yarn_company_name:'Lana Grossa', permalink:'lana-grossa-cool-wool-2000',
      yarn_weight:{name:'Fingering'}, grams:50, yardage:160, rating_average:'4.5', machine_washable:'yes',
      yarn_fibers:[{fiber:{name:'Merino Wool'},percentage:100}] },
  ];

  const filtered = query
    ? base.filter(y => {
        const ql = query.toLowerCase();
        return y.name.toLowerCase().includes(ql)
          || (y.yarn_company_name||'').toLowerCase().includes(ql)
          || getFibers(y).some(f => f.toLowerCase().includes(ql));
      })
    : base;

  const chunkSize = 8;
  const start = (page-1) * chunkSize;
  return {
    yarns: filtered.slice(start, start + chunkSize),
    pages: Math.ceil(filtered.length / chunkSize)
  };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFibers(y) {
  if (!y.yarn_fibers || !y.yarn_fibers.length) return [];
  return y.yarn_fibers
    .filter(f => f.fiber && f.fiber.name)
    .map(f => f.percentage ? `${f.fiber.name} ${f.percentage}%` : f.fiber.name);
}
function ratingStars(r) {
  if (!r || r === 'â€”') return 'â˜†â˜†â˜†â˜†â˜†';
  const n = Math.round(+r);
  return 'â˜…'.repeat(n) + 'â˜†'.repeat(5 - n);
}
function randEmoji(i) { return EMOJIS[i % EMOJIS.length]; }
function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  BOOT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  // activate first chip
  document.querySelector('.chip[data-q="wool"]').classList.add('active');
  loadYarns('wool', 1);
  if (apiUser && apiPass) {
    document.getElementById('apiKeyBox').style.display = 'none';
  }
});
</script>
</body>
</html>
